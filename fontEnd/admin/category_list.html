<meta charset="UTF-8">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.css">
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="http://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
<link type="text/css" rel="stylesheet" href="http://unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
<link type="text/css" rel="stylesheet" href="http:unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css"/>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<script>
  if (!sessionStorage.getItem('token')) {
    location.href = 'login.html';
  }

  function logOut() {
    sessionStorage.removeItem('token');
    location.href = 'login.html';
  }
</script>
<div id ='app' v-if="user.body.author_id">
  <nav class="navbar navbar-expand-lg navbar-dark p-0" style="background-color: #1f282dd9">
    <div class="navbar-nav">
      <a class="nav-item nav-link" href="index_admin.html">Quản lý bài viết</a>
      <a class="nav-item nav-link active" href="category_list.html">Quản lý nhóm bài viết</a>
      <a class="nav-item nav-link" href="media.html">Quản lý ảnh bài viết</a>
    </div>
  
    <ul class="navbar-nav ml-auto">
      <li class="nav-item dropdown no-arrow">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">
          <img v-if="user.body.author_photo" class="rounded-circle z-depth-2" style="width:60px;height: 60px;" :src="API_URL+'/' + user.body.author_photo">
          <img v-else class="rounded-circle" style="width:60px" src="user.svg">
        </a>
        <div class="dropdown-menu dropdown-menu-right">
          <a class="dropdown-item" href="user_profile.html">
            Thông tin tài khoản
          </a>
          <a class="dropdown-item" href="change_password.html">
            Đổi mật khẩu
        </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#" onclick="logOut()">
            Đăng xuất
          </a>
        </div>
      </li>
    </ul>
  </nav>
  <div class="mt-3 container">
  <template>
    <a class="btn btn-primary" style="margin-bottom: 5px;" href="create_update_category.html">
      Thêm nhóm bài viết
    </a>
    <table class="table table-bordered">
      <tr>
        <th class="text-center" style="width: 10%;">STT</th>
        <th class="text-center" style="width: 30%;">Mã</th>
        <th class="text-center" style="width: 30%;">Tên</th>
        <th class="text-center" style="width: 20%;"></th>
      </tr>
      <tr v-for='(c,i) in categories.body'>
        <td class="text-center">{{i+1}}</td>
        <td class="text-center">CT000{{c.id}}</td>
        <td class="text-center">{{c.title}}</td>
        <td class="text-center">
          <a class="btn btn-sm btn-primary" 
              :href='"create_update_category.html?id=" + c.id'>Chỉnh sửa</a>
          <a class="btn btn-sm btn-danger" v-on:click="deleteCategory(c.id)" href='#'>Xóa</a>
        </td>
      </tr>
    </table>
    <b-pagination v-model="paging.currentPage" :total-rows="paging.count" :per-page="perPage"
    v-on:input="getListCategories(url2+paging.currentPage)">
</b-pagination>
<p class="mt-3">Trang hiện tại: {{ paging.currentPage }}</p>
  </template>
</div>
</div>
<script>

  new Vue({
    el: '#app',
    data(){
      return { 
      perPage: 5,
      paging: {
          currentPage: "1",
          count: "",
          previous: "",
          next: "",
          total_page: "",
      },
      categories: [],
      API_URL :'http://localhost:8000',
      url:'http://localhost:8000/root/list_categories',
      url2:'http://localhost:8000/root/list_categories?page=',
      user: {
            body:{
                author_photo:"",
                author_id:"",
            }}
      }
    },

    methods: {
      getUser: async function(){
            var resp = await fetch(this.API_URL+"/root/get_user",
                    {
                        headers: {'Authorization': 'Bearer ' + sessionStorage.getItem('token'), "Content-Type": "application/json",}
                    });
                    this.user = await resp.json()
                    if(this.user.body.success === false){
                        sessionStorage.removeItem('token');
                        location.href = 'login.html';
                    }
          },
      getListCategories: async function(url){
        var resp = await fetch(url,
            {
              headers: {'Authorization': 'Bearer ' 
                            + sessionStorage.getItem('token')}
            });
      this.categories = await resp.json();
      this.paging = this.categories.paging
      },
      deleteCategory: async function(id) {
        if(confirm("Bạn có thực sự muốn xóa !")){
        var resp = await fetch(this.API_URL+'/root/delete_category/'+id,
                                    {method: 'DELETE'});
        var result = await resp.json();
        if(result.body.success){
          location.href = 'category_list.html';
          alert('Xóa Thành công');
        }else {
          alert('Lỗi khi xóa.');
        }
      };
      },
    },

    created: async function () {
      await this.getListCategories(this.url);
      await this.getUser()
    }
  })
</script>